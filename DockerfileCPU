# syntax=docker/dockerfile:1

# Use a slim Python image as the base
FROM python:3.10-slim-bookworm

# Set environment variables
ENV PYTHONUNBUFFERED=1

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /code

# Copy only requirements to cache them in docker layer
COPY pyproject.toml poetry.lock /code/

# Install pip-tools to compile requirements from pyproject.toml
RUN pip install pip-tools

# Create requirements.txt from pyproject.toml
RUN pip-compile pyproject.toml --output-file=requirements.txt

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy the rest of the application code
COPY pypi_scout /code/pypi_scout/

# Copy the start script and make it executable
COPY start.sh /start.sh
RUN chmod +x /start.sh

# Make empty data directory
RUN mkdir -p /code/data

# Use the script as the entrypoint
ENTRYPOINT ["/start.sh"]
